name: Build and publish multi-platform Docker images on ghcr.io (nightly/new release)

# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

on:
  # Run daily at 9:15 AM UTC (nightly builds)
  schedule:
    # Publish "nightly" build as release
    - cron: '15 9 * * *'
  push:
    # Publish semver tags as releases (e.g., 1.0.0)
    tags: [ '*.*.*' ]
  # or on button click
  workflow_dispatch:

env:
  # Use docker.io for Docker Hub if empty
  REGISTRY_HOST: ghcr.io
  # Use github.repository (<account>/<repo>)
  REPOSITORY_NAME: ${{ github.repository }}
  # Use github.repository_owner (<account>)
  OWNER_NAME: ${{ github.repository_owner }}

jobs:
  build:
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        image:
          - boca-web
          # - boca-jail
        platform:
          - linux/amd64
          - linux/arm/v7
          - linux/arm64/v8
          - linux/ppc64le
          - linux/s390x
    services:
      registry:
        image: registry:2
        ports:
          - 5000:5000
    runs-on: ubuntu-latest

    steps:
      # Checkout a repository, so the workflow can access it
      # https://github.com/marketplace/actions/checkout
      - 
        name: Checkout repository
        uses: actions/checkout@v3

      # Add support for more platforms with QEMU (optional)
      # https://github.com/docker/setup-qemu-action
      -
        name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      # Create and boot a builder that can be used in the following steps of the workflow
      # https://github.com/docker/setup-buildx-action
      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
        with:
          driver-opts: network=host

      # Set an environment variable
      # https://docs.github.com/en/github-ae@latest/actions/using-workflows/workflow-commands-for-github-actions#setting-an-environment-variable
      - 
        name: Normalize and write PLATFORM_NAME variable to GITHUB_ENV
        run: |
          platform='${{ matrix.platform }}'
          # Replace '/' with '-'
          echo "PLATFORM_NAME=${platform//\//-}" >> $GITHUB_ENV

      # Cache storage backends with GitHub Actions
      # https://github.com/actions/cache
      -
        name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache-${{ env.PLATFORM_NAME }}
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      # Login to a Docker registry (except on PR)
      # https://github.com/docker/login-action
      - 
        name: Login to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY_HOST }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Extract metadata (tags, labels) for Docker
      # https://github.com/docker/metadata-action
      - 
        name: Extract Docker metadata (${{ matrix.image }})
        id: meta_base
        uses: docker/metadata-action@v4
        with:
          images: localhost:5000/${{ env.REPOSITORY_NAME }}/boca-base

      - 
        name: Extract Docker metadata (${{ matrix.image }})
        id: meta_image
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY_HOST }}/${{ env.REPOSITORY_NAME }}/${{ matrix.image }}

      # - 
      #   name: Extract Docker metadata (boca-jail)
      #   id: meta_jail
      #   uses: docker/metadata-action@v4
      #   with:
      #     images: ${{ env.REGISTRY_HOST }}/${{ env.REPOSITORY_NAME }}/boca-jail

      # Build and push Docker image with Buildx (don't push on PR)
      # https://github.com/docker/build-push-action
      - 
        name: Build and push image locally (boca-base)
        uses: docker/build-push-action@v4
        with:
          context: .
          file: docker/dev/base/Dockerfile
          platforms: ${{ matrix.platform }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta_base.outputs.tags }}
          labels: ${{ steps.meta_base.outputs.labels }}
          cache-from: type=local,src=/tmp/.buildx-cache-${{ env.PLATFORM_NAME }}
          cache-to: type=local,dest=/tmp/.buildx-cache-new-${{ env.PLATFORM_NAME }},mode=max

      -
        # Temp fix
        # https://github.com/docker/build-push-action/issues/252
        # https://github.com/moby/buildkit/issues/1896
        name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache-${{ env.PLATFORM_NAME }}
          mv /tmp/.buildx-cache-new-${{ env.PLATFORM_NAME }} /tmp/.buildx-cache-${{ env.PLATFORM_NAME }}

      - 
        name: Write FOLDER_NAME variable to GITHUB_ENV
        run: |
          dir='${{ matrix.image }}'
          # Remove 'boca-' from image name
          echo "FOLDER_NAME=${dir//boca-/}" >> $GITHUB_ENV

      - 
        name: Build and push image remotely (${{ matrix.image }})
        uses: docker/build-push-action@v4
        with:
          context: .
          file: docker/dev/${{ env.FOLDER_NAME }}/Dockerfile
          platforms: ${{ matrix.platform }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta_image.outputs.tags }}
          labels: ${{ steps.meta_image.outputs.labels }}
          build-args: |
            BASE_IMAGE=${{ steps.meta_base.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # - 
      #   name: Build and push image (boca-jail)
      #   uses: docker/build-push-action@v4
      #   with:
      #     context: .
      #     file: docker/dev/jail/Dockerfile
      #     platforms: ${{ matrix.platform }}
      #     push: ${{ github.event_name != 'pull_request' }}
      #     tags: ${{ steps.meta_jail.outputs.tags }}
      #     labels: ${{ steps.meta_jail.outputs.labels }}
      #     build-args: |
      #       BASE_IMAGE=${{ steps.meta_base.outputs.tags }}
      #     cache-from: type=gha
      #     cache-to: type=gha,mode=max

      # - 
      #   name: Build and export image to file (boca-base)
      #   uses: docker/build-push-action@v4
      #   with:
      #     context: .
      #     file: docker/dev/base/Dockerfile
      #     tags: boca-base
      #     outputs: type=docker,dest=/tmp/boca-base_${{ env.PLATFORM_NAME }}.tar
      #     cache-from: type=local,src=/tmp/.buildx-cache-${{ env.PLATFORM_NAME }}
      #     cache-to: type=local,dest=/tmp/.buildx-cache-new-${{ env.PLATFORM_NAME }},mode=max

      - 
        name: Build and export image to file (${{ matrix.image }})
        uses: docker/build-push-action@v4
        with:
          context: .
          file: docker/dev/${{ env.FOLDER_NAME }}/Dockerfile
          platforms: ${{ matrix.platform }}
          tags: ${{ matrix.image }}_${{ env.PLATFORM_NAME }}
          build-args: |
            BASE_IMAGE=${{ steps.meta_base.outputs.tags }}
          outputs: type=docker,dest=/tmp/${{ matrix.image }}_${{ env.PLATFORM_NAME }}.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # - 
      #   name: Build and export image to file (boca-jail)
      #   uses: docker/build-push-action@v4
      #   with:
      #     context: .
      #     file: docker/dev/jail/Dockerfile
      #     platforms: ${{ matrix.platform }}
      #     tags: boca-jail_${{ env.PLATFORM_NAME }}
      #     build-args: |
      #       BASE_IMAGE=${{ steps.meta_base.outputs.tags }}
      #     outputs: type=docker,dest=/tmp/boca-jail_${{ env.PLATFORM_NAME }}.tar
      #     cache-from: type=gha
      #     cache-to: type=gha,mode=max

      # Upload images allowing to share them between jobs
      # https://github.com/actions/upload-artifact
      # -
      #   name: Upload image (boca-base)
      #   uses: actions/upload-artifact@v3
      #   with:
      #     name: boca-base_${{ env.PLATFORM_NAME }}
      #     path: /tmp/boca-base_${{ env.PLATFORM_NAME }}.tar
      #     retention-days: 7

      -
        name: Upload image (${{ matrix.image }})
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.image }}_${{ env.PLATFORM_NAME }}
          path: /tmp/${{ matrix.image }}_${{ env.PLATFORM_NAME }}.tar
          retention-days: 7

      # -
      #   name: Upload image (boca-jail)
      #   uses: actions/upload-artifact@v3
      #   with:
      #     name: boca-jail_${{ env.PLATFORM_NAME }}
      #     path: /tmp/boca-jail_${{ env.PLATFORM_NAME }}.tar
      #     retention-days: 7

  scan:
    permissions:
      # for actions/checkout to fetch code
      contents: read
      # for github/codeql-action/upload-sarif to upload SARIF results
      security-events: write
      # only required for a private repository by github/codeql-action/upload-sarif 
      # to get the Action run status
      actions: read
    strategy:
      matrix:
        image:
          - boca-web
          # - boca-jail
        platform:
          - linux/amd64
          # - linux/arm/v7
          # - linux/arm64/v8
          # - linux/ppc64le
          # - linux/s390x
    runs-on: ubuntu-latest
    needs: build

    steps:
      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - 
        name: Normalize and write PLATFORM_NAME variable to GITHUB_ENV
        run: |
          platform='${{ matrix.platform }}'
          # Replace '/' with '-'
          echo "PLATFORM_NAME=${platform//\//-}" >> $GITHUB_ENV

      # Download artifact from build
      # https://github.com/actions/download-artifact
      -
        name: Download artifact (Docker image)
        uses: actions/download-artifact@v3
        with:
          name: '${{ matrix.image }}_${{ env.PLATFORM_NAME }}'
          path: /tmp

      -
        name: Load Docker image from file
        run: |
          docker load --input /tmp/${{ matrix.image }}_${{ env.PLATFORM_NAME }}.tar
          docker image ls -a

      # Run Trivy vulnerability scanner on image
      # https://github.com/marketplace/actions/aqua-security-trivy
      - 
        name: Run Trivy vulnerability scanner on image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ matrix.image }}_${{ env.PLATFORM_NAME }}'
          format: 'sarif'
          output: 'trivy-${{ matrix.image }}-${{ env.PLATFORM_NAME }}-image-results.sarif'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
          timeout: 10m

      # Upload results to GitHub so they can be displayed in the repository' security tab
      # https://github.com/github/codeql-action
      - 
        name: Upload Trivy image scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-${{ matrix.image }}-${{ env.PLATFORM_NAME }}-image-results.sarif'
          category: 'image'

  # Ensure that the repository is given Admin access by going on
  # Package settings -> Manage Actions access
  # https://github.com/actions/delete-package-versions/issues/74
  cleanup:
    permissions:
      packages: write
    strategy:
      matrix:
        image:
          - boca-web
          # - boca-jail
    runs-on: ubuntu-latest
    needs: build

    steps:
      - 
        name: Write PACKAGE_NAME variable to GITHUB_ENV
        run: |
          owner='${{ env.OWNER_NAME }}'
          repo='${{ env.REPOSITORY_NAME }}'
          # Remove owner from repository's name
          echo "PACKAGE_NAME=${repo//$owner\//}" >> $GITHUB_ENV

      # Delete versions of a package from GitHub Packages
      # https://github.com/marketplace/actions/delete-package-versions
      - 
        name: Delete untagged Docker images on ghcr.io
        uses: actions/delete-package-versions@v4
        with: 
          package-name: '${{ env.PACKAGE_NAME }}/${{ matrix.image }}'
          package-type: 'container'
          token: ${{ secrets.GITHUB_TOKEN }}
          min-versions-to-keep: 0
          delete-only-untagged-versions: 'true'
